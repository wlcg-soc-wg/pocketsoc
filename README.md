# docker-soc-demonstrator

## Introduction

A test, **non-production** SOC demonstrator, intended to track the lifecycle of an event. 

## Components

The current containers used by this demonstrator are:

### Interactive
- client

### Data/Traffic sources
- apache\*
- flask\*
- ssh\*

### Infrastructure
- router

### SOC (IDS)
- bro

### SOC (Threat Intelligence)
- misp-web
- misp-db

### SOC (Analytics)
- elasticsearch
- logstash
- kibana

### SOC (Alerting)
- elastalert

### Notes

- `misp-web` and `misp-db` are used from the misp-docker (XME edition) repo, part of the official MISP project, which is included as a submodule.
- `elasticsearch`, `kibana` and `logstash` are used from the docker-elk repo, https://github.com/deviantony/docker-elk, which uses the official elastic docker containers. 
- \* `apache` , `flask` and `ssh` are intended to scale to multiple instances.

## Networks

Three internal docker networks are used:

- internal
- external
- mirror

Each container is configured to belong to a specific set of these: 

- client: `internal` only
- apache: `external` only
- flask: `external` only
- bro: `mirror` only
- router: `internal`:`external`:`mirror`
- misp-web: `mirror` only
- misp-db: `mirror` only
- elasticsearch: `mirror` only
- logstash: `mirror` only
- kibana: `mirror` only

The router is then configured to route traffic between the client and apache/flask instances, mirroring the consequent packets to the bro node via the mirror network.

A network diagram showing the configuration is given [here][1]

## Usage

### Quickstart

- Clone repo
- Inside repo, run `configure.sh` to 
	- pull in submodules
	- set up the networking
	- patch the misp-web Dockerfile to personalise our instance
	- set up the Docker volumes for the submodules
		- misp-web
		- misp-db
		- elasticsearch
		- logstash
		- kibana
- Run `docker-compose up`
- Build will take some time initially if starting from scratch
- Following build, containers will be automatically started
- Visit `127.0.0.1:8040` to see MISP login page
	  - Log in with `admin@admin.test:admin` and change password
          - Administration ->
          - List Users ->
          - Copy `Authkey` for `admin`
          - In repo directory, run `tools/updateauthkey.sh COPIEDKEY` to update the key used by `bro` to pull MISP data
- Visit `127.0.0.1:8060` to see Kibana front page
	-  After a brief wait to allow Elasticsearch to ingest data, set up indexes
		- Discover -\>
		- `Index pattern`: logstash\*
		- Next step -\>
		- Select `@timestamp` from dropdown menu
		- Create index pattern -\>
		- Discover -\>
		- For example, choose fields of interest
- Use  `docker exec -it client bash` to access the client container and access the traffic sources. 

### Troubleshooting

- If containers don't start properly, `Ctrl-C` to stop containers, and re-run `docker-compose up` (particularly if you see error messages like "could not connect to database")
- Make sure you're in the `docker-soc-demonstrator` directory proper - there are other `docker-compose.yml` files in the `misp-docker` subdirectory (the XME misp-docker repo) and `docker-elk` subdirectory, but we override this with different network settings to make our cluster work.

### Demo workflow

An initial demo could include showing that network traffic, where one endpoint is identified in a MISP event, can 

1. be tracked with bro
2. be identified as matching intelligence by bro for further action

Steps to follow

- After setting up admin account on MISP, note on front page that no events exist
- Visit user page and flag authentication key for later use
- on `bro`, visit `/opt/bro/logs/current/` and look in `conn.log` and `http.log`- should see connection attempt from `bro` to `misp-web` trying to fetch intel. This will not be working. This is a good time to note that different types of traffic will have specific logs autogenerated (if you have the relevant scripts enabled)
- copy auth key to `/files/simplemisp.sh`
- Note in `conn.log` that the connections to misp-web continue. You can also see in `http.log` that these should have switched from `403:Forbidden` to `200:OK`. 
- You can use `bro-cut` here to pull out particular fields, eg `cat http.log | /opt/bro/bin/bro-cut -d ts id.orig_h id.resp_h status_code status_msg | tail -1` to get the last entry
- Should now be able to see contents of `/files/feeds/testdata.txt` - just file headings
- On `client`, check that demo\_apache\_1 is accessible and issue `curl http://demo_apache_1/` which should give "SOC Demonstrator, static content"
- On `client` check the IP address of `demo_apache_1`
- on `bro`, should note presence of this IP in `conn.log`
- in MISP UI (`127.0.0.1:8040`), add an event with "Event info -\> Demo"  and add an attribute:
	- Category: Network activity
	- Type: ip-dst
	- Value: `demo_apache_1` IP
	- Check *for Intrusion Detection System*
- From sidebar, issue *Publish Event* -\> *YES*
- on `bro`, check that `/files/feeds/testdata.txt` now populates with this data (takes \> 5 secs)
- on `client`, rerun `curl http://demo_apache_1/`
- on `bro`, check that the `demo_apache_1` IP again appears in `conn.log`
- on `bro`, there should also now be an `intel.log` file with relevant matches.
- FOR ADDITIONAL DETAILING 
	- Various examples of traffic analysis can be carried out using kibana
	- Various combinations of apache/flask instances can be spun up to represent more "typical" traffic patterns

[1]:	demonstrator-network-diagram.svg
